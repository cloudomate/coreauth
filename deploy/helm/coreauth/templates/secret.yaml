{{- if not .Values.config.jwt.existingSecret }}
{{- $secretName := include "coreauth.secretName" . }}
{{- $existingSecret := lookup "v1" "Secret" .Release.Namespace $secretName }}
apiVersion: v1
kind: Secret
metadata:
  name: {{ $secretName }}
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "coreauth.labels" . | nindent 4 }}
type: Opaque
data:
  {{/* JWT secret — auto-generate if not provided, preserve across upgrades */}}
  {{- if .Values.config.jwt.secret }}
  jwt-secret: {{ .Values.config.jwt.secret | b64enc | quote }}
  {{- else if and $existingSecret (index $existingSecret.data "jwt-secret") }}
  jwt-secret: {{ index $existingSecret.data "jwt-secret" }}
  {{- else }}
  jwt-secret: {{ randAlphaNum 64 | b64enc | quote }}
  {{- end }}

  {{/* Database password */}}
  {{- if not .Values.externalDatabase.existingSecret }}
  {{- if .Values.postgresql.enabled }}
  db-password: {{ .Values.postgresql.auth.password | b64enc | quote }}
  {{- else if .Values.externalDatabase.password }}
  db-password: {{ .Values.externalDatabase.password | b64enc | quote }}
  {{- else if and $existingSecret (index $existingSecret.data "db-password") }}
  db-password: {{ index $existingSecret.data "db-password" }}
  {{- end }}
  {{- end }}

  {{/* Database URL */}}
  {{- if not .Values.externalDatabase.existingSecret }}
  {{- if .Values.postgresql.enabled }}
  database-url: {{ printf "postgresql://%s:%s@%s-postgresql:5432/%s" .Values.postgresql.auth.username .Values.postgresql.auth.password (include "coreauth.fullname" .) .Values.postgresql.auth.database | b64enc | quote }}
  {{- else if .Values.externalDatabase.password }}
  database-url: {{ printf "postgresql://%s:%s@%s:%s/%s" .Values.externalDatabase.user .Values.externalDatabase.password .Values.externalDatabase.host .Values.externalDatabase.port .Values.externalDatabase.database | b64enc | quote }}
  {{- else if and $existingSecret (index $existingSecret.data "database-url") }}
  database-url: {{ index $existingSecret.data "database-url" }}
  {{- end }}
  {{- end }}

  {{/* Redis URL */}}
  {{- if not .Values.externalRedis.existingSecret }}
  {{- if .Values.redis.enabled }}
  redis-url: {{ printf "redis://%s-redis-master:6379" (include "coreauth.fullname" .) | b64enc | quote }}
  {{- else if .Values.externalRedis.url }}
  redis-url: {{ .Values.externalRedis.url | b64enc | quote }}
  {{- else if and $existingSecret (index $existingSecret.data "redis-url") }}
  redis-url: {{ index $existingSecret.data "redis-url" }}
  {{- end }}
  {{- end }}

  {{/* Admin password — auto-generate if not provided */}}
  {{- if .Values.bootstrap.admin.password }}
  admin-password: {{ .Values.bootstrap.admin.password | b64enc | quote }}
  {{- else if and $existingSecret (index $existingSecret.data "admin-password") }}
  admin-password: {{ index $existingSecret.data "admin-password" }}
  {{- else }}
  admin-password: {{ randAlphaNum 24 | b64enc | quote }}
  {{- end }}

  {{/* SMTP password (conditional) */}}
  {{- if and .Values.config.smtp.password (not .Values.config.smtp.existingSecret) }}
  smtp-password: {{ .Values.config.smtp.password | b64enc | quote }}
  {{- end }}

  {{/* Twilio auth token (conditional) */}}
  {{- if and .Values.config.twilio.authToken (not .Values.config.twilio.existingSecret) }}
  twilio-auth-token: {{ .Values.config.twilio.authToken | b64enc | quote }}
  {{- end }}

  {{/* SMPP password (conditional) */}}
  {{- if and .Values.config.smpp.password (not .Values.config.smpp.existingSecret) }}
  smpp-password: {{ .Values.config.smpp.password | b64enc | quote }}
  {{- end }}
{{- end }}
